#!/bin/sh

case "$1" in
start|stop|restart|attach|dettach|taka*)
    ;;
*)
    echo "usage: nfsctl [command]" 1>&2
    echo "    start   - startup all relative nfs services" 1>&2
    echo "    stop    - stop all relative nfs services" 1>&2
    echo "    restart - restart all relative nfs services" 1>&2
    echo "    attach  - (experimental)" 1>&2
    echo "    dettach - (experimental)" 1>&2
    exit
    ;;
esac

case "$1" in
attach)
	mkdir -p /Users/${USER}/z/Movies
	mkdir -p /Users/${USER}/z/docs-ONGS
	mkdir -p /Users/${USER}/z/docs-daichi
	mkdir -p /Users/${USER}/z/docs-shuzai
	mkdir -p /Users/${USER}/z/nfs-takasyou
	mkdir -p /Users/${USER}/z/nfs-sasaki

	# 文字列をUFC（Unicode Normalization Form C：ユニコード正規化形式C）に
	# 変換して送信するオプション -o nfs を指定しておかないと、濁点を含む
	# ファイルなどが適切に扱えなくなる。
	[ -z "$(mount -t nfs | grep z/Movies     )" ] && sudo mount_nfs -o nfc 192.168.1.10:/home/netdisk/Movies     /Users/${USER}/z/Movies
	[ -z "$(mount -t nfs | grep z/docs-ONGS  )" ] && sudo mount_nfs -o nfc 192.168.1.10:/home/docs-ONGS          /Users/${USER}/z/docs-ONGS
	[ -z "$(mount -t nfs | grep z/docs-daichi)" ] && sudo mount_nfs -o nfc 192.168.1.10:/home/docs-daichi        /Users/${USER}/z/docs-daichi
	[ -z "$(mount -t nfs | grep z/docs-shuzai)" ] && sudo mount_nfs -o nfc 192.168.1.10:/home/docs-shuzai        /Users/${USER}/z/docs-shuzai
	[ -z "$(mount -t nfs | grep z/nfs-takasyou)" ] && sudo mount_nfs -o nfc 192.168.1.10:/home/nfs-takasyou      /Users/${USER}/z/nfs-takasyou
	[ -z "$(mount -t nfs | grep z/nfs-sasaki  )" ] && sudo mount_nfs -o nfc 192.168.1.10:/home/nfs-sasaki        /Users/${USER}/z/nfs-sasaki

# ユーザが所属するグループを Dacolm で管理されているグループと同じものに
# しないと ls でなにも表示されないので、次のようにグループを作成し、
# 使用するユーザを所属させる。
# sudo dscl . -craete /Groups/smbusers
# sudo dscl . -create /Groups/smbusers name smbusers
# sudo dscl . -create /Groups/smbusers passwd "*"
# sudo dscl . -create /Groups/smbusers realname smbusers
# sudo dscl . -create /Groups/smbusers PrimaryGroupID 1002
# sudo dscl . -append /Groups/smbusers GroupMembership daichi
#
# FreeBSD 9.0-STABLEのNFSv4とMac OS X MavericksのNFSv4マウントは相性が
# 悪くまともに動作しない。しばらくはNFSv3で接続して運用する。
	;;
dettach)
	sudo umount -f /Users/${USER}/z/Movies > /dev/null 2>&1
	sudo umount -f /Users/${USER}/z/docs-ONGS > /dev/null 2>&1
	sudo umount -f /Users/${USER}/z/docs-daichi > /dev/null 2>&1
	sudo umount -f /Users/${USER}/z/docs-shuzai > /dev/null 2>&1
	sudo umount -f /Users/${USER}/z/nfs-takasyou > /dev/null 2>&1
	sudo umount -f /Users/${USER}/z/nfs-sasaki > /dev/null 2>&1
	;;
start)
	;;
stop)
	;;
restart)
	;;
esac

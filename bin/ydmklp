#!/bin/sh -xv

# PID record
pidfile=".build.pid"
echo "$$" > "$pidfile"

# XXX for DEBUG
logfile="/tmp/ydmklp-$$"
exec > $logfile
trap "rm -f \"$logfile\" \"$pidfile\"" EXIT
# XXX

while :
do
    if [ ! -e typescript.xml ]
    then
        sleep 0.1
    else
        break
    fi
done

while :
do
    wait_filechanges .

    # adapting to vi/vim save behavior
    sleep 0.5

    if [ -e .build-lock ]
    then
        continue
    fi

		# If the default images are used, try to get new ones.
		# (If there are no files under the images directory that are 
		#  newer than the images directory, it is assumed that the 
		#  default image is being used.)
		if [ -z "$(find images -newer images 2> /dev/null)" ]
		then
		    # Save the modification time of the images directory.
		    mkdir images.timestamp-saved
				touch -r images images.timestamp-saved

				# Get the images.
		    make getimg 2> /dev/null

				# Restore the modification time of the images directory.
				touch -r images.timestamp-saved images
				rm -d images.timestamp-saved
		fi

    make clean
    errormsg=$(make)

    case $? in
    0)
        make upload
        ;;
    1)
        echo "${errormsg}"
        ;;
    esac
done

#!/bin/sh -xv

#====================================================================
# PID recorded
#====================================================================
pidfile=".build.pid"
echo "$$" > "$pidfile"

# XXX for DEBUG
logfile="/tmp/ydmklp-$$"
exec > $logfile
trap "rm -f \"$logfile\" \"$pidfile\"" EXIT
# XXX

#====================================================================
# Waiting for target file generation
#====================================================================
while :
do
    if [ ! -e typescript.xml ]
    then
        sleep 0.1
    else
        break
    fi
done

#====================================================================
# Build processing loop
#====================================================================
while :
do
		#----------------------------------------------------------------
    # waiting for one of the files to be updated
		#----------------------------------------------------------------
    wait_filechanges .

		#----------------------------------------------------------------
    # adapting to vi/vim save behavior
		#----------------------------------------------------------------
    sleep 0.5

		#----------------------------------------------------------------
    # Avoid processing during build lock mode
		#----------------------------------------------------------------
    if [ -e .build-lock ]
    then
        continue
    fi

		#----------------------------------------------------------------
    # Automatic acquisition of image files
		#----------------------------------------------------------------
    # If the default images are used or do not exist, try to get 
		# new images. If the images have been acquired manually, it will 
		# not be acquired automatically.

		# Number of files unter the images directory
		nofs=$(find images -type f -maxdepth 1 2> /dev/null | awk 'END{print NR}')
		# If there are no files in the images directory, attempt to
		# retrieve the image files.

		# A file that indicates that images were automatically acquired 
		# from this script.
		confirmationfile="images/.got-by-ydmklp"

    if [ 0 -eq $nofs -o ! -f "$confirmationfile" ]
    then
        # Get the images.
        make getimg 2> /dev/null

				# Record that the image was automatically acquired from this 
				# script.
        touch "$confirmationfile"
    fi

		#----------------------------------------------------------------
    # Build process
		#----------------------------------------------------------------
    make clean
    errormsg=$(make)

		#----------------------------------------------------------------
    # Upload the required files
		#----------------------------------------------------------------
    case $? in
    0)
        make upload
        ;;
    1)
        echo "${errormsg}"
        ;;
    esac
done

#!/bin/sh

#========================================================================
# TSVデータから円グラフ画像を作成する
#========================================================================

#========================================================================
# 作業用ディレクトリの作成と削除トラップの設定
#========================================================================
tmpd=/tmp/$$
rm	-rf $tmpd
mkdir	-p $tmpd
trap	"[ -d $tmpd ] && chmod -R u+w $tmpd; rm -rf $tmpd" EXIT

#========================================================================
# Google Charts用HTMLテンプレート
#========================================================================
cat<<EOF							> $tmpd/html1
<html  lang="ja">
  <head>
    <meta charset="utf-8">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
      google.charts.load('current', {'packages':['corechart']});
      google.charts.setOnLoadCallback(drawChart);

      function drawChart() {

        var data = google.visualization.arrayToDataTable([
EOF

# ここに下記形式のデータ
#    データ形式:
#	['項目','値'],
#	['名前1',値1],
#	['名前2',値2],
#	  ...
#	['名前N',値N]

cat<<EOF							> $tmpd/html2
        ]);

        var options = {
          title: ''
        };

        var chart = new google.visualization.PieChart(document.getElementById('piechart'));

        chart.draw(data, options);
      }
    </script>
  </head>
  <body>
    <div id="piechart" style="width: 1200px; height: 800px;"></div>
  </body>
</html>
EOF

#========================================================================
# グラフデータをGoogle Charts用データに加工
#========================================================================
# データ形式:
#	['項目','値'],
#	['名前1',値1],
#	['名前2',値2],
#	  ...
#	['名前N',値N]
#
echo	-n "['項目','値'],"					> $tmpd/data
cat	$1							|
tsv2ssv								|
awk	"{printf(\"['%s',%s]\\n\",\$1,\$2)}"			|
sed	's/_/ /g'						|
sed	's/$/,/'						|
tr	-d '\n'							|
sed	's/,$//'						>>$tmpd/data

#========================================================================
# Google Charts用グラフHTMLファイルを作成
#========================================================================
cat	$tmpd/html1						\
	$tmpd/data						\
	$tmpd/html2						> $tmpd/chart.html

#========================================================================
# 
#========================================================================
getss	$tmpd/chart.html

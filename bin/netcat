#!/bin/sh

#========================================================================
# URLで指定されたリソースを取得
#========================================================================
url=${@}

#========================================================================
# 作業用ディレクトリの作成と削除トラップの設定
#========================================================================
tmpd=/tmp/$$
rm	-rf $tmpd 
mkdir	-p $tmpd
trap	"[ -d $tmpd ] && chmod -R u+w $tmpd; rm -rf $tmpd" EXIT

#========================================================================
# Webリソース取得に利用するアプリケーション
#========================================================================
curl='curl'
msedge='/c/Program Files (x86)/Microsoft/Edge/Application/msedge.exe'
chrome='/Applications/Google Chrome.app/Contents/MacOS/Google Chrome'
agent='Mozilla/5.0 (Windows NT 10.0; Win64; x64)'

#========================================================================
# Webリソースの種類を取得
#========================================================================
case	"$url" in
*.html|*.htm|*.shtml|*/)
	ct="text/html"
	;;
*.txt)
	ct="text/plain"
	;;
*.csv|*csv=1)
 	ct="text/csv"
 	;;
*.pdf)
	ct="application/pdf"
	;;
*.zip)
	ct="application/zip"
	;;
*)
	getrs="$curl --insecure --location --compressed -Ss -I"
	ct=$($getrs -A "$agent" ${@} | grep -i '^content-type: ')
	;;
esac

#========================================================================
# Webリソースを取得する方法を選択
#========================================================================
case	"${ct}" in
*text/html*)
	#================================================================
	# HTMLコンテンツ: JavaScriptでコンテンツを表示するタイプのページ
	# にも対応するため、なるべくWebブラウザのヘッドレスモードを使用
	#================================================================

	if	[ -e "$msedge" ]
	then
		#========================================================
		# Microsoft Edgeを使って取得 (Windows)
		#========================================================
		method="msedge"
	
	elif	[ -e "$chrome" ]
	then
		#========================================================
		# Google Chromeを使って取得 (Mac)
		#========================================================
		method="chrome"
	
	else
		#=======================================================
		# curl を使って取得
		#=======================================================
		method="curl"
	fi
	;;
*)
	#================================================================
	# それ以外のコンテンツは curl を使って取得
	#================================================================
	method="curl"
	;;
esac

#========================================================================
# Webブラウザのヘッドレスモードで取得できないサイトを除外
#========================================================================
# case	"${1}" in
# 取得できるものの、時間がかかる。しかし取得はできるので様子見。
# https://*360.com/*)	method="curl" ;;
# esac

#========================================================================
# Webリソースを取得
#========================================================================
case	"${method}" in
msedge)
	#================================================================
	# Microsoft Edgeを使って取得 (Windows)
	#================================================================
	"$msedge"	--headless					\
			--dump-dom					\
			--enable-logging 				\
			--lang=en-US					\
			--user-agent="$agent"				\
			"$url"
# --virtual-time-budget=10000 を指定すると取得できないサイトが出てくる
	;;
chrome)
	#================================================================
	# Google Chromeを使って取得 (Mac)
	#================================================================
	"$chrome"	--headless					\
			--dump-dom					\
			--lang=en-US					\
			--user-agent="$agent"				\
			"$url"						> $tmpd/out

# --virtual-time-budget=10000 を指定すると取得できないサイトが出てくる

	# Mac Google Chrome は取得に失敗することがあるので、失敗した場合は
	# curlでの取得を試みる
	if	[ -s $tmpd/out ]
	then
		cat	$tmpd/out
	else
		method=curl
	fi
	;;
esac

case	"${method}" in
curl)
	#================================================================
	# curl を使って取得する方法
	#================================================================
	"$curl"		--insecure 					\
			-A "$agent" 					\
			--location 					\
			--compressed 					\
			-get "$url" 
	;;
esac

#!/bin/sh

#========================================================================
# URLで指定されたリソースを取得
#========================================================================

#========================================================================
# 作業用ディレクトリの作成と削除トラップの設定
#========================================================================
tmpd=/tmp/$$
rm	-rf $tmpd 
mkdir	-p $tmpd
trap	"[ -d $tmpd ] && chmod -R u+w $tmpd; rm -rf $tmpd" EXIT

#========================================================================
# Webリソース取得に利用するアプリケーション
#========================================================================
msedge='/c/Program Files (x86)/Microsoft/Edge/Application/msedge.exe'
chrome='/Applications/Google Chrome.app/Contents/MacOS/Google Chrome'
curl='curl'
agent='Mozilla/5.0 (Windows NT 10.0; Win64; x64)'

#========================================================================
# どの方法でWebリソースを取得するかを判断
#========================================================================
case "${1}" in
*.[pP][dD][fF])
	#================================================================
	# PDFはヘッドレスモードの取得がうまく機能しないため、curlを
	# 使用する
	#================================================================
	method="curl"
	;;
*.[cC][sSD][vV])
	#================================================================
	# CSVはヘッドレスモードの取得がうまく機能しないため、curlを
	# 使用する
	#================================================================
	method="curl"
	;;
*)
	#================================================================
	# Microsoft Edgeを使って取得 (Windows)
	#================================================================
	if [ -e "$msedge" ]
	then
		method="msedge"
	
	#================================================================
	# Google Chromeを使って取得 (Mac)
	#================================================================
	elif [ -e "$chrome" ]
	then
		method="chrome"
	
	#================================================================
	# curl を使って取得する方法
	#================================================================
	else
		method="curl"
	fi
	;;
esac

#========================================================================
# Webブラウザ系のヘッドレスモードでは取得できないサイトかどうかを判断
#========================================================================
case	"${1}" in
https://*sucuri*/*)	method="curl" ;;
#https://*adobe*/*)	method="curl" ;;
esac

#========================================================================
# Webリソースを取得
#========================================================================
case	"${method}" in
msedge)
	#================================================================
	# Microsoft Edgeを使って取得 (Windows)
	#================================================================
	"$msedge"	--headless					\
			--dump-dom					\
			--enable-logging 				\
			--lang=en-US					\
			--user-agent="$agent"				\
			--virtual-time-budget=10000			\
			${@}
	;;
chrome)
	#================================================================
	# Google Chromeを使って取得 (Mac)
	#================================================================
	"$chrome"	--headless					\
			--dump-dom					\
			--lang=en-US					\
			--user-agent="$agent"				\
			--virtual-time-budget=20000			\
			${@}						> $tmpd/out
	# Mac Google Chrome は取得に失敗することがあるので、失敗した場合は
	# curlでの取得を試みる
	if [ -s $tmpd/out ]
	then
		cat	$tmpd/out
	else
		method=curl
	fi
	;;
esac

case	"${method}" in
curl)
	#================================================================
	# curl を使って取得する方法
	#================================================================
	"$curl"		--insecure 					\
			-A "$agent" 					\
			--location 					\
			--compressed 					\
			-get ${@}
	;;
esac

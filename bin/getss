#!/bin/sh

#========================================================================
# スクリーンショットを取得する
#========================================================================

#========================================================================
# デフォルトサイズおよびスクリーンショットファイル
#========================================================================
width=1200
height=800
outfile=${HOME}/ss.png

#========================================================================
# スクリーンショット取得に利用するアプリケーション
#========================================================================
curl='curl'
msedge='/c/Program Files (x86)/Microsoft/Edge/Application/msedge.exe'
chrome='/Applications/Google Chrome.app/Contents/MacOS/Google Chrome'
agent='Mozilla/5.0 (Windows NT 10.0; Win64; x64)'

#========================================================================
# オプションを処理
#========================================================================
while	getopts f:Lw:h: OPT
do
	case $OPT in
	f)
		outfile="$OPTARG"
		;;
	w) 
		width="$OPTARG"
		;;
	h) 
		height="$OPTARG"
		;;
	esac
done
shift	$((OPTIND - 1))

#========================================================================
# スクリーンショット取得対象
#========================================================================
uri="$(eval echo '$'{$#})"

#========================================================================
# リソースの種類を特定
#========================================================================
case	"$uri" in
http*)
	url="${uri}"
	;;
*)
	ct="none"
	;;
esac

case "${url:-none}" in
*.html|*.htm|*.shtml|*/)
	ct="text/html"
	;;
*.txt)
	ct="text/plain"
	;;
*.csv|http*csv=1)
 	ct="text/csv"
 	;;
*.pdf)
	ct="application/pdf"
	;;
*.zip)
	ct="application/zip"
	;;
*)
	getrs="$curl --insecure --location --compressed -Ss -I"
	ct=$($getrs -A "$agent" ${@} | grep -i '^content-type: ')
	;;
esac

#========================================================================
# どの方法でスクリーンショットを取得するかを判断
#========================================================================
case	"${ct}" in
*text/html*|*text/plain*)
	#================================================================
	# Microsoft Edgeを使って取得 (Windows)
	#================================================================
	if [ -e "$msedge" ]
	then
		method="msedge"
	
	#================================================================
	# Google Chromeを使って取得 (Mac)
	#================================================================
	elif [ -e "$chrome" ]
	then
		method="chrome"

	#================================================================
	# 該当するアプリケーションなし
	#================================================================
	else
		method="none"
	fi
	;;
none)
	#================================================================
	# デスクトップのスクリーンショットを取得する
	# XXX OSごとに画面のスクリーンショットを取る処理をそのうち実装
	#================================================================
	;;
esac

#========================================================================
# スクリーンショットが取れないページの場合、代わりに http://example.com/
# のスクリーンショットを取っておく
#========================================================================
case	"${ct}" in
*/*)
	case	"${url}" in
	# https://*foo.bar.com/*)		url="http://example.com/" ;;
	esac
	;;
esac

#========================================================================
# Webページのスクリーンショットを取得
#========================================================================
case	"${ct}" in
*/*)
	case	"${method}" in
	msedge)
		#========================================================
		# Microsoft Edgeを使って取得 (Windows)
		#========================================================
		"$msedge"	--headless				\
				--lang=en-US				\
				--user-agent="$agent"			\
				--window-size=$width,$height		\
				--screenshot="$outfile"			\
				--hide-scrollbars			\
				"${url}"
		;;
#				--virtual-time-budget=20000		\
	chrome)
		#========================================================
		# Google Chromeを使って取得 (Mac)
		#========================================================
		"$chrome"	--headless				\
				--lang=en-US				\
				--user-agent="$agent"			\
				--window-size=$width,$height		\
				--screenshot="$outfile"			\
				--hide-scrollbars			\
				"${url}"
		# Mac Google Chrome は --virtual-time-budget を指定すると
		# 動作が停止することが多いので、指定を行わない
		;;
	esac
	;;

#========================================================================
# デスクトップのスクリーンショットを取得
#========================================================================
*)
	# XXX OSごとに画面のスクリーンショットを取る処理をそのうち実装
	;;
esac

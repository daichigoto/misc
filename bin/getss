#!/bin/sh

#========================================================================
# スクリーンショットを取得する
#========================================================================

#========================================================================
# デフォルトサイズおよびスクリーンショットファイル
#========================================================================
width=1200
height=800
outfile=${HOME}/ss.png

#========================================================================
# スクリーンショット取得に利用するアプリケーション
#========================================================================
curl='curl'
msedge='/c/Program Files (x86)/Microsoft/Edge/Application/msedge.exe'
chrome='/Applications/Google Chrome.app/Contents/MacOS/Google Chrome'
snippingtool='SnippingTool.exe'
agent='Mozilla/5.0 (Windows NT 10.0; Win64; x64)'

#========================================================================
# オプションを処理
#========================================================================
while	getopts f:Lw:h: OPT
do
	case $OPT in
	f)
		outfile="$OPTARG"
		;;
	w) 
		width="$OPTARG"
		;;
	h) 
		height="$OPTARG"
		;;
	esac
done
shift	$((OPTIND - 1))

#========================================================================
# スクリーンショット取得対象URI
#========================================================================
uri="$*"

#========================================================================
# リソースの種類を特定
#========================================================================
case	"$uri" in
http*)
	#================================================================
	# コンテンツの種類を特定
	#================================================================
	case	"${uri}" in
	*.html|*.htm|*.shtml|*/)
		ct="text/html"
		;;
	*.txt|*.TXT)
		ct="text/plain"
		;;
	*.csv|*.CSV|http*csv=1)
	 	ct="text/csv"
	 	;;
	*.pdf|*.PDF)
		ct="application/pdf"
		;;
	*.zip|*.ZIP)
		ct="application/zip"
		;;
	*)
		getrs="$curl --insecure --location --compressed -Ss -I"
		ct=$($getrs -A "$agent" ${uri} | grep -i '^content-type: ')
		;;
	esac
	;;
"")
	uri="desktop:"
	;;
*)
	uri=none:
	;;
esac

#========================================================================
# どの方法でスクリーンショットを取得するかを判断
#========================================================================
case	"${ct}" in
*/*)
	#================================================================
	# Microsoft Edgeを使って取得 (Windows)
	#================================================================
	if	[ -e "$msedge" ]
	then
		method="msedge"
	
	#================================================================
	# Google Chromeを使って取得 (Mac)
	#================================================================
	elif	[ -e "$chrome" ]
	then
		method="chrome"

	#================================================================
	# 該当するアプリケーションなし
	#================================================================
	else
		method="none"
	fi
	;;
esac

#========================================================================
# スクリーンショットが取れないページの場合、代わりに http://example.com/
# のスクリーンショットを取っておく
#========================================================================
case	"$ct" in
*text/html*|*text/plain*)
	case	"$uri" in
	# https://*foo.bar.com/*)		uri="http://example.com/" ;;
	esac
	;;
*/*)
	uri="http://example.com/"
esac

#========================================================================
# Webページのスクリーンショットを取得
#========================================================================
case	"$uri" in
http*)
	case	"${ct}" in
	*/*)
		case	"${method}" in
		msedge)
			#================================================
			# Microsoft Edgeを使って取得 (Windows)
			#================================================
			"$msedge"	--headless			\
					--lang=en-US			\
					--user-agent="$agent"		\
					--window-size=$width,$height	\
					--screenshot="$outfile"		\
					--hide-scrollbars		\
					"$uri"
			;;
	#				--virtual-time-budget=20000	\
		chrome)
			#================================================
			# Google Chromeを使って取得 (Mac)
			#================================================
			"$chrome"	--headless			\
					--lang=en-US			\
					--user-agent="$agent"		\
					--window-size=$width,$height	\
					--screenshot="$outfile"		\
					--hide-scrollbars		\
					"$uri"
			# Mac Google Chrome は --virtual-time-budget を
			# 指定すると動作が停止することが多いので、指定を
			# 行わない
			;;
		esac
		;;
	esac
	;;
esac

#========================================================================
# デスクトップのスクリーンショットを取得
#========================================================================
case	"$uri" in
desktop:*)
	#================================================================
	# Windowsでスクリーンショットを撮る
	#================================================================
	if	type "$snippingtool"					> /dev/null
	then
		"$snippingtool"
	fi
	;;
esac

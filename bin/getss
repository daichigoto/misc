#!/bin/sh

#========================================================================
# スクリーンショットを取得する
#========================================================================

#========================================================================
# デフォルトサイズおよびスクリーンショットファイル
#========================================================================
width=1200
height=800
outfile=${HOME}/ss.png

#========================================================================
# スクリーンショット取得に利用するアプリケーションほか
#========================================================================
curl='curl'
msedge='/c/Program Files (x86)/Microsoft/Edge/Application/msedge.exe'
chrome='/Applications/Google Chrome.app/Contents/MacOS/Google Chrome'
webagent='Mozilla/5.0 (Windows NT 10.0; Win64; x64)'
snippingtool='SnippingTool.exe'

#========================================================================
# オプションを処理
#========================================================================
while	getopts f:Lw:h: OPT
do
	case $OPT in
	f)
		outfile="$OPTARG"
		;;
	w) 
		width="$OPTARG"
		;;
	h) 
		height="$OPTARG"
		;;
	esac
done
shift	$((OPTIND - 1))

#========================================================================
# スクリーンショット取得対象URI
#========================================================================
uri="$*"

# 指定がない場合はdeskop:を指定
if	[ -z "$uri" ]
then
	uri="desktop:"
fi

#========================================================================
# どの方法でスクリーンショットを取得するか判断
#========================================================================
case	"$uri" in
http*)
	#================================================================
	# Microsoft Edgeを使って取得 (Windows)
	#================================================================
	if	[ -e "$msedge" ]
	then
		method="msedge"
	
	#================================================================
	# Google Chromeを使って取得 (Mac)
	#================================================================
	elif	[ -e "$chrome" ]
	then
		method="chrome"
	fi
	;;
desktop:*)
	#================================================================
	# Snipping Toolを使って取得 (Windows)
	#================================================================
	if	type "$snippingtool"					> /dev/null
	then
		method="snippingtool"
	fi
	;;
*)
	method="none"
	;;
esac

#========================================================================
# リソース種類の特定
#========================================================================
case	"$uri" in
http*)
	#================================================================
	# コンテンツの種類を特定
	#================================================================
	case	"$uri" in
	*.html|*.htm|*.shtml|*/)
		ct="text/html"
		;;
	*.txt|*.TXT)
		ct="text/plain"
		;;
	*.csv|*.CSV|http*csv=1)
	 	ct="text/csv"
	 	;;
	*.pdf|*.PDF)
		ct="application/pdf"
		;;
	*.zip|*.ZIP)
		ct="application/zip"
		;;
	*)
		getrs="$curl --insecure --location --compressed -Ss -I"
		ct=$($getrs -A "$webagent" ${uri} | grep -i '^content-type: ')
		;;
	esac
	;;
esac

#========================================================================
# スクリーンショットが取れないWebリソースの場合、代わりに 
# http://example.com/ のスクリーンショットを取っておく
#========================================================================
case	"$ct" in
*text/html*|*text/plain*)
	case	"$uri" in
	# https://*foo.bar.com/*)		uri="http://example.com/" ;;
	esac
	;;
*/*)
	uri="http://example.com/"
esac

#========================================================================
# スクリーンショットを取得
#========================================================================
case	"${method}" in
msedge)
	#================================================
	# Microsoft Edgeを使って取得 (Windows)
	#================================================
	"$msedge"	--headless			\
			--lang=en-US			\
			--user-agent="$webagent"	\
			--window-size=$width,$height	\
			--screenshot="$outfile"		\
			--hide-scrollbars		\
			--virtual-time-budget=2000	\
			"$uri"
	# ページ読み込み後にコンテンツをロードするタイプの
	# Webページはしばらく待つ必要があるため、そのために
	# --virtual-time-budget= で待機時間を指定している。
	;;
chrome)
	#================================================
	# Google Chromeを使って取得 (Mac)
	#================================================
	"$chrome"	--headless			\
			--lang=en-US			\
			--user-agent="$webagent"	\
			--window-size=$width,$height	\
			--screenshot="$outfile"		\
			--hide-scrollbars		\
			"$uri"
	# Mac Google Chrome は --virtual-time-budget を
	# 指定すると動作が停止することが多いので、指定を
	# 行わない
	;;
snippingtool)
	#================================================
	# Snipping Toolを使って取得 (Windows)
	#================================================
	"$snippingtool"
	;;
esac

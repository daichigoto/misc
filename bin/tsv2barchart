#!/bin/sh

#========================================================================
# TSVãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç¸¦æ£’ã‚°ãƒ©ãƒ•ç”»åƒã‚’ä½œæˆã™ã‚‹
#========================================================================

#========================================================================
# ä½œæ¥­ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆã¨å‰Šé™¤ãƒˆãƒ©ãƒƒãƒ—ã®è¨­å®š
#========================================================================
tmpd=/tmp/$$
rm	-rf $tmpd
mkdir	-p $tmpd
trap	"[ -d $tmpd ] && chmod -R u+w $tmpd; rm -rf $tmpd" EXIT

#========================================================================
# ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å‡¦ç†
#========================================================================
outfile=chart.png
type=png
while	getopts o:t:D OPT
do
	case $OPT in
	# å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’æŒ‡å®š
	o)
		outfile="$OPTARG"
		;;
	# ç”»åƒå½¢å¼ã‚’æŒ‡å®š
	t) 
		type="$OPTARG"
		;;
	D)
		debug="on"
		;;
	esac
done
shift	$((OPTIND - 1))

#========================================================================
# å¼•æ•°ã«ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¿…è¦ã€‚ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã«ã¯
# å‡¦ç†ã‚’çµ‚äº†
#========================================================================
if	[ "1" != $# ]
then
	exit 1
fi

#========================================================================
# Google Chartsç”¨HTMLãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
#========================================================================
cat<<EOF							> $tmpd/html1
<html  lang="ja">
  <head>
    <meta charset="utf-8">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
      google.charts.load('current', {'packages':['corechart', 'bar']});
      google.charts.setOnLoadCallback(drawChart);

      function drawChart() {

        var data = google.visualization.arrayToDataTable([
EOF

# ã“ã“ã«ä¸‹è¨˜å½¢å¼ã®ãƒ‡ãƒ¼ã‚¿(ä¸‹è¨˜ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ç”Ÿæˆã—ã¦ã„ã‚‹)
#    ãƒ‡ãƒ¼ã‚¿å½¢å¼:
#	['é …ç›®','å€¤'],
#	['åå‰1',å€¤1],
#	['åå‰2',å€¤2],
#	  ...
#	['åå‰N',å€¤N]

cat<<EOF							> $tmpd/html2
        ]);

	// 2023-02-10 å¾Œè—¤
	// ç¸¦æ£’ã‚°ãƒ©ãƒ•(ColumnChart)ã¯Yè»¸ã®ãƒ©ãƒ™ãƒ«è¡¨ç¤ºãŒä¸€éƒ¨æ¶ˆãˆã‚‹ãŸã‚ã€æ¯”è¼ƒçš„
	// ãã“ãŒå´©ã‚Œãªã„æ¨ªæ£’ã‚°ãƒ©ãƒ•(BarChart)ã‚’ä½¿ã†ã€‚ãŸã ã—ã€æ¨ªæ£’ã‚°ãƒ©ãƒ•ã§ã‚‚
	// Yè»¸ã®ãƒ©ãƒ™ãƒ«ã¯å´©ã‚Œã‚‹ã€‚ãŸã ã€chartArea: {width: '60%'} ã‚’æŒ‡å®šã™ã‚‹ã¨
	// è¡¨ç¤ºãŒã‹ãªã‚Šã¾ã—ã«ãªã‚‹ã®ã§ã€ä¸‹è¨˜ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ã£ã¦ã„ã‚‹ã€‚
        var options = {
	  width: 1200,
	  height: 800,
	  chartArea: {width: '60%'},
	  legend: { position: 'none' }
        };

	// ãƒãƒ£ãƒ¼ãƒˆã‚’ç”Ÿæˆ
        var chart = new google.visualization.BarChart(document.getElementById('chart'));

	// ãƒãƒ£ãƒ¼ãƒˆã®æç”»å®Œäº†å¾Œã«çµ„ã¿è¾¼ã¿PNGç”»åƒæ–‡å­—åˆ—ãƒ‡ãƒ¼ã‚¿(Base64)ã¨ã—ã¦è¡¨ç¤º
	google.visualization.events.addListener(chart, 'ready', function () {
	  document.getElementById('chartdata').innerHTML = chart.getImageURI();
	});

        // ãƒãƒ£ãƒ¼ãƒˆã‚’æç”»
	chart.draw(data, options);
      }
    </script>
  </head>
  <body>
    <div id="chart" style="width: 1200px; height: 800px;"></div>
    <p id="chartdata"></p>
  </body>
</html>
EOF

#========================================================================
# ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ã‚’Google Chartsç”¨ãƒ‡ãƒ¼ã‚¿ã«åŠ å·¥
#========================================================================
# ãƒ‡ãƒ¼ã‚¿å½¢å¼:
#	['é …ç›®','å€¤'],
#	['åå‰1',å€¤1],
#	['åå‰2',å€¤2],
#	  ...
#	['åå‰N',å€¤N]
#
echo	-n "['é …ç›®','å€¤'],"					> $tmpd/data
cat	$1							|
tsv2ssv								|
awk	"{printf(\"['%s',%s]\\n\",\$1,\$2)}"			|
sed	's/_/ /g'						|
sed	's/$/,/'						|
tr	-d '\n'							|
sed	's/,$//'						>>$tmpd/data

#========================================================================
# Google Chartsç”¨ã‚°ãƒ©ãƒ•HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
#========================================================================
cat	$tmpd/html1						\
	$tmpd/data						\
	$tmpd/html2						> $tmpd/chart.html

#========================================================================
# Google Chartsç”¨ã‚°ãƒ©ãƒ•HTMLãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‹ã‚‰WebDriverã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹
# ãƒ‘ã‚¹ã‚’ä½œæˆã™ã‚‹
#========================================================================
charthtmlpath=$tmpd/chart.html
case	$(uname) in
MSYS*)
	charthtmlpath=C:/msys64/$tmpd/chart.html
esac

#========================================================================
# Google Chartsç”¨ã‚°ãƒ©ãƒ•HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒãƒ£ãƒ¼ãƒˆç”»åƒã®Base64ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
#========================================================================
# ç†ç”±ã¯ä¸æ˜ã ãŒã€ã€Œ///*[@id="chartdata"]ã€ã§PowerShellã«ã¯
# ã€Œ//*[@id="chartdata"]ã€ã¨ã—ã¦æ¸¡ã£ã¦ãã‚‹ãŸã‚ãã®ã‚ˆã†ã«æŒ‡å®š
# ã—ã¦ã‚ã‚‹ã€‚ã€Œ//ã€ãŒã€Œ/ã€ã«å¤‰æ›ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹ã€‚
gettext_fromhtml.ps1						\
	"$charthtmlpath"					\
	'///*[@id="chartdata"]'					|
#
# PowerShell $PROFILEãŒåŸå› ã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã€
# ã“ã‚ŒãŒãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦å«ã¾ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹ãŸã‚ã€ãã†ã—ãŸãƒ‡ãƒ¼ã‚¿ã¯
# å‰Šé™¤ã—ã¦ãŠãã€‚
grep	-v '^'						|
#
# çµ„ã¿è¾¼ã¿ç”»åƒã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤ã—ã¦ç”»åƒãƒ‡ãƒ¼ã‚¿ã®Base64ã®ã¿ã«ã™ã‚‹ã€‚
grep	'^data:image'						|
sed	's|data:image/png;base64,||'				> $tmpd/chart.b64

#========================================================================
# ãƒãƒ£ãƒ¼ãƒˆç”»åƒã®Base64ãƒ‡ãƒ¼ã‚¿ã‚’ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã™ã‚‹
#========================================================================
base64	-d $tmpd/chart.b64					> $tmpd/chart.png

#========================================================================
# ç”»åƒå½¢å¼ã‚’å¤‰æ›
#========================================================================
case	${type} in
png)
	cp 	$tmpd/chart.png					\
		$tmpd/out."$type"
	;;
*)
	gm	convert						\
		-quality 100					\
		$tmpd/chart.png					\
		$tmpd/out."$type"
	;;
esac

#========================================================================
# ãƒãƒ£ãƒ¼ãƒˆç”»åƒã‚’å‡ºåŠ›
#========================================================================
cp	$tmpd/out."$type"					\
	"$outfile"

#========================================================================
# ãƒ‡ãƒãƒƒã‚°ç”¨æ©Ÿèƒ½
#========================================================================
if	[ "on" == "$debug" ]
then
	cp	$charthtmlpath					\
		~/Desktop/chart.html
	cp	$tmpd/chart.b64					\
		~/Desktop/chart.b64.txt
fi
